<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open App or Store</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body style="background: #f00">
    <h1>Opening App...</h1>
    <p>If nothing happens, <a id="store-link" href="#">click here</a> to download the app.</p>
    <!--<iframe id="l" width="100" height="100" style="border:10px solid blue"></iframe>-->
    <iframe src="tesla://inbox" style="display:none"></iframe>

    <script>
        // Configure these values for your app
        const config = {
            ios: {
                appScheme: '', // Your app's custom URL scheme
                appStoreUrl: 'https://apps.apple.com/us/app/tesla/id582007913',
                universalLink: 'https://www.tesla.com/get-app/inbox_message_list_screen' // If you support Universal Links
            },
            android: {
                appScheme: 'yourapp://',
                playStoreUrl: 'https://play.google.com/store/apps/details?id=your.package.name',
                intentUrl: 'intent://your-host#Intent;scheme=yourapp;package=your.package.name;end'
            }
        };
        const appStoreUrl = 'https://apps.apple.com/us/app/tesla/id582007913';
        const deepLinkUrl = 'tesla://foo';

        function openApp() {
            const el = document.getElementById("l");
            if (!el) {
                alert('el not found');
                return;
            }
            el.src = deepLinkUrl;

            const start = Date.now();
            setTimeout(() => {
                location.href = deepLinkUrl;
            }, 1);
            setTimeout(() => {
                alert('took:' + (Date.now() - start))
            }, 1)


            // If app isn't opened within 2 seconds, redirect to App Store
            // setTimeout(() => {
            //     window.location = config.ios.appStoreUrl;
            //     // window.open(config.ios.appStoreUrl, '_self');
            // }, 500);
        }

        // Update store link href based on platform
        document.getElementById('store-link').href = config.ios.appStoreUrl;

        // Try to open app when page loads
        // window.onload = function() {
        //     // openApp();
        //     // setup fallback (redirect to App Store)
        //     var start = (new Date()).valueOf();
        //     setTimeout(function() {
        //         var end = (new Date()).valueOf();

        //         // prevent App Store redirect upon returning to safari from myapp
        //         if (end - start > 1000) return;

        //         // get a seamless redirect if you use itms://... instead of http://itunes.com/...
        //         window.location = appStoreUrl;
        //     }, 25);

        //     // Attempt to load my custom url scheme
        //     window.location = deepLinkUrl;
        // };

        function ghtest() {
            function DeepLinker(options) {
                if (!options) {
                    throw new Error('no options')
                }

                var hasFocus = true;
                var didHide = false;

                // window is blurred when dialogs are shown
                function onBlur() {
                    hasFocus = false;
                };

                // document is hidden when native app is shown or browser is backgrounded
                function onVisibilityChange(e) {
                    if (e.target.visibilityState === 'hidden') {
                    didHide = true;
                    }
                };

                // window is focused when dialogs are hidden, or browser comes into view
                function onFocus() {
                    if (didHide) {
                    if (options.onReturn) {
                        options.onReturn();
                    }

                    didHide = false; // reset
                    } else {
                    // ignore duplicate focus event when returning from native app on
                    // iOS Safari 13.3+
                    if (!hasFocus && options.onFallback) {
                        // wait for app switch transition to fully complete - only then is
                        // 'visibilitychange' fired
                        setTimeout(function() {
                        // if browser was not hidden, the deep link failed
                        if (!didHide) {
                            options.onFallback();
                        }
                        }, 1000);
                    }
                    }

                    hasFocus = true;
                };

                // add/remove event listeners
                // `mode` can be "add" or "remove"
                function bindEvents(mode) {
                    [
                    [window, 'blur', onBlur],
                    [document, 'visibilitychange', onVisibilityChange],
                    [window, 'focus', onFocus],
                    ].forEach(function(conf) {
                    conf[0][mode + 'EventListener'](conf[1], conf[2]);
                    });
                }

                // add event listeners
                bindEvents('add');

                // expose public API
                this.destroy = bindEvents.bind(null, 'remove');
                this.openURL = function(url) {
                    // it can take a while for the dialog to appear
                    var dialogTimeout = 500;

                    setTimeout(function() {
                    if (hasFocus && options.onIgnored) {
                        options.onIgnored();
                    }
                    }, dialogTimeout);

                    window.location = url;
                };
            }

            /* usage */

            var url = 'yelp://';
            var badURL = 'test://slkdfs';

            var linker = new DeepLinker({
            onIgnored: function() {
                console.log('browser failed to respond to the deep link');
                window.location = appStoreUrl;
            },
            onFallback: function() {
                console.log('dialog hidden or user returned to tab');
                // window.location = appStoreUrl;
                window.location = appStoreUrl;
            },
            onReturn: function() {
                console.log('user returned to the page from the native app');
            },
            });

            linker.openURL(url);
        }

        // ghtest();

        setTimeout(function () { 
            window.location = "#";  // Effectively cancels the following window.location command if the app is not installed.
            // $('#smartAppBanner').show(); // Make up your own smart app banner, and show it.
        }, 100);
        window.open("yelp://", "_self");
    </script>
</body>
</html>
